Analytics Data Accuracy – Budget and Metrics Alignment: The corporate/agency analytics endpoints now enforce org access, but some metrics may be incorrect due to data type mismatches and partial syncing of booking info. Notably, trip budget is stored as a text field
GitHub
 and not always updated when bookings are made, causing the analytics to under-report finances. For example, totalBudget is computed by summing trip.budget only if it’s numeric
GitHub
 – any non-numeric or string budget yields 0
GitHub
. If an AI-generated trip or booking sets budget as a string (e.g., “$5000” or left blank), the analytics ignore it.
📍 Evidence: The trips schema defines budget as text
GitHub
. In getAnalytics() (corporate view), totalBudget is calculated with a reducer summing trip.budget assuming numbers
GitHub
. The code explicitly adds 0 for non-numeric types, so a budget stored as "5000" (string) won’t count. Furthermore, when an Amadeus flight is booked or hotel selected, there’s no code updating the trip’s budget with actual costs (the budget field remains whatever was initially set or generated).
❗ Why it Matters: Accurate analytics are crucial for enterprise reporting. Misreported budget totals or trip counts could mislead admins. Also, if bookings aren’t reflected in budgets, companies cannot use the platform to track travel spend properly. This is partly a data modeling issue and partly workflow: the system should either store budgets as numeric (and in a consistent currency) or parse them when aggregating.
✅ Fix: Convert the budget to a numeric type or consistently parse it. If multi-currency support is needed, store a numeric value and currency separately. Apply a migration to cast existing text budgets to numbers where possible. Update trip creation and update logic to ensure budget is set as a number (e.g., parse user input or AI output “$5000” to 5000). Additionally, when implementing real booking integrations, update the trip’s budget or cost breakdown after a booking is confirmed (perhaps add a expenses table or at least update trip.budget sum). This might involve hooking into the createBooking flow to update the trip record.
🧠 Replit Agent Prompt: “Standardize the budget field as a number. Modify the database schema (trips.budget) to numeric (INT/DECIMAL) and update code accordingly. Ensure all places that set or use budget (trip generation, analytics) handle it as numeric. If budget is provided as a string with currency symbols, strip them and parse to number.”
🧪 Testing: Create a trip with a known budget (say $1000). Call the analytics endpoint (e.g., /api/analytics/corporate?userId=<user>). Verify that the totalBudget in the response equals 1000. Next, simulate a booking: for instance, “book” a flight costing $300 for that trip (this might be a manual DB update if booking is not fully implemented). After the fix, either the trip’s budget should increment or an expense record created. The analytics should then reflect the new total (e.g., 1300). Also test input edge cases: entering “5,000” or “$5000 USD” as budget should still be parsed to 5000.